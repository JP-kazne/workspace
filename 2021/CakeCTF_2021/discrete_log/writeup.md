# Writeup

以下のプログラムと出力が与えられる。

```py
from Crypto.Util.number import getPrime, isPrime, getRandomRange

def getSafePrime(bits):
    while True:
        p = getPrime(bits - 1)
        q = 2*p + 1
        if isPrime(q):
            return q

with open("flag.txt", "rb") as f:
    flag = f.read().strip()

p = getSafePrime(512)
g = getRandomRange(2, p)
r = getRandomRange(2, p)

cs = []
for m in flag:
    cs.append(pow(g, r*m, p))

print(p)
print(g)
print(cs)
```

```
10577926960839937947442162797370864980541285292536671603546595533193324977125572190720609448828374782284663027664894813711243894320697692129630847705557539
9947724104164898694903023872711663896409433873530762235716749042436185304062119886390357927264325412355223958396239523671881766361219889894069645084522127
[1229288066188188446140572951590585838131579917371511162649288281094421402493758271918280416055465305258850798174813421022714679676287728499647253120374695, 10432993487247272012480923097160918670223939440020584956672587338819387564406156095947231487677556954828864387429116143245429963057004783904414488840483883, 8846898594122745402315346660588103073817097798204431437711034651813289442774837730820134043682352683522453026507938275715350738931942754620858572095894833, 4045640615389787749853661262284447508612987648607573956251553736198615257540512882528800714431424850616135969142451005730805426191941965206855411616865846, 1229288066188188446140572951590585838131579917371511162649288281094421402493758271918280416055465305258850798174813421022714679676287728499647253120374695, 1945428232655195080994800854254286050005395375198086738205807646894444509288423023719076721279967584478447554044287458681202684205941300518455664909896770, 10354621433690291080863817499954203913680345790427806490217953854290390664868635054642758139322526900976315271173855068718334823237601765344488054950961045, 6450396411196778288237471377707156944771360666868782593043200729952706897922338702645020446957804453347793935766075212035314665465699530609262139446841794, 6603165839364347784941569364866161781386478404222821544628017382892389369481107861540318475846446163066953093646715054906626664043485319179748812018187608, 10432993487247272012480923097160918670223939440020584956672587338819387564406156095947231487677556954828864387429116143245429963057004783904414488840483883, 4042600243432470792279319238797089674031093707099421074301129639348359908738591074209975141693531653698877970720299975180608931933840731135919239266129531, 9753045617655554075535397949256980647454831331391019636944817636801025863316405956657883053760816735577807443396030910262012333972455514593468821229847216, 10432993487247272012480923097160918670223939440020584956672587338819387564406156095947231487677556954828864387429116143245429963057004783904414488840483883, 5705490906960110528538635141558499052089268217498141288524505028321355953649986725466752682611329558447209023808467500672466053160864942319360366767522428, 10446004960956011058336954345576506542925522395495166475000278575199457691832910056903330578472321806954810895742286832849843203812788582215022283968968442, 2785996600898026596024204925975309018606205305214377134460494244584059497511759664894757187838328097195872398784106625161459942753354545213358279449633332, 5705490906960110528538635141558499052089268217498141288524505028321355953649986725466752682611329558447209023808467500672466053160864942319360366767522428, 8518396356987073160446226593505514680842064427706567536033369420610810908882528653260766790896766994789384117506763080763933744536854279875382388996716393, 4045640615389787749853661262284447508612987648607573956251553736198615257540512882528800714431424850616135969142451005730805426191941965206855411616865846, 10446004960956011058336954345576506542925522395495166475000278575199457691832910056903330578472321806954810895742286832849843203812788582215022283968968442, 4042600243432470792279319238797089674031093707099421074301129639348359908738591074209975141693531653698877970720299975180608931933840731135919239266129531, 4045640615389787749853661262284447508612987648607573956251553736198615257540512882528800714431424850616135969142451005730805426191941965206855411616865846, 5940089364090396255891114323486822488149883598124290813680817411219364338155445538437115753453598481449101247255466882855753225125970871768839102953427252, 1451759830404925477558275270642407378934999719484439203872342683020817625642737205582986542429047217317435872276960585914530151288082605818539662897325059, 4042600243432470792279319238797089674031093707099421074301129639348359908738591074209975141693531653698877970720299975180608931933840731135919239266129531, 10432993487247272012480923097160918670223939440020584956672587338819387564406156095947231487677556954828864387429116143245429963057004783904414488840483883, 3844728289551481985429176289449289604000304789858654366566902189290267618563940933188833996034764887276042750051165636121466021492112395693389564386737849, 5940089364090396255891114323486822488149883598124290813680817411219364338155445538437115753453598481449101247255466882855753225125970871768839102953427252, 10446004960956011058336954345576506542925522395495166475000278575199457691832910056903330578472321806954810895742286832849843203812788582215022283968968442, 10446004960956011058336954345576506542925522395495166475000278575199457691832910056903330578472321806954810895742286832849843203812788582215022283968968442, 6603165839364347784941569364866161781386478404222821544628017382892389369481107861540318475846446163066953093646715054906626664043485319179748812018187608, 5940089364090396255891114323486822488149883598124290813680817411219364338155445538437115753453598481449101247255466882855753225125970871768839102953427252, 2785996600898026596024204925975309018606205305214377134460494244584059497511759664894757187838328097195872398784106625161459942753354545213358279449633332, 9753045617655554075535397949256980647454831331391019636944817636801025863316405956657883053760816735577807443396030910262012333972455514593468821229847216, 2785996600898026596024204925975309018606205305214377134460494244584059497511759664894757187838328097195872398784106625161459942753354545213358279449633332, 10432993487247272012480923097160918670223939440020584956672587338819387564406156095947231487677556954828864387429116143245429963057004783904414488840483883, 6075040072394386353700068186624559720007996691077752316710222658102597630426876503425968551345482454171942016710393973778088713964073715708282771166108340, 5940089364090396255891114323486822488149883598124290813680817411219364338155445538437115753453598481449101247255466882855753225125970871768839102953427252, 4045640615389787749853661262284447508612987648607573956251553736198615257540512882528800714431424850616135969142451005730805426191941965206855411616865846, 10446004960956011058336954345576506542925522395495166475000278575199457691832910056903330578472321806954810895742286832849843203812788582215022283968968442, 2319394889752437261970357119967349450311229179467143254112633795132104201041540419394974595546896804379819748025776699134680309317217660482163282654767536]
```

![g, p, g^{r*m}\mod p](https://render.githubusercontent.com/render/math?math=%5Cdisplaystyle+g%2C+p%2C+g%5E%7Br%2Am%7D%5Cmod+p)が与えられており、![m](https://render.githubusercontent.com/render/math?math=%5Cdisplaystyle+m)を求めればよい。

![r](https://render.githubusercontent.com/render/math?math=%5Cdisplaystyle+r)はランダムな値なので求めることができない。

フラグのフォーマットが`CakeCTF{...} = [67, 97, 107, 101, 67, 84, 70, 123, ... , 125]`であることから、以下の値が分かっていることになる。

![\begin{align*}
g^{67*r} \mod p\\
g^{97*r} \mod p\\
g^{107*r} \mod p\\
g^{101*r} \mod p\\
g^{64*r} \mod p\\
g^{70*r} \mod p\\
g^{123*r} \mod p\\
g^{125*r} \mod p\\
\end{align*}](https://render.githubusercontent.com/render/math?math=%5Cdisplaystyle+%5Cbegin%7Balign%2A%7D%0Ag%5E%7B67%2Ar%7D+%5Cmod+p%5C%5C%0Ag%5E%7B97%2Ar%7D+%5Cmod+p%5C%5C%0Ag%5E%7B107%2Ar%7D+%5Cmod+p%5C%5C%0Ag%5E%7B101%2Ar%7D+%5Cmod+p%5C%5C%0Ag%5E%7B64%2Ar%7D+%5Cmod+p%5C%5C%0Ag%5E%7B70%2Ar%7D+%5Cmod+p%5C%5C%0Ag%5E%7B123%2Ar%7D+%5Cmod+p%5C%5C%0Ag%5E%7B125%2Ar%7D+%5Cmod+p%5C%5C%0A%5Cend%7Balign%2A%7D)

あとは、これらの逆元を計算するなどして、![g^r \mod p](https://render.githubusercontent.com/render/math?math=%5Cdisplaystyle+g%5Er+%5Cmod+p)
を計算すれば、![g^{m*r} * g^r  \equiv g^{(m+1)*r} \mod p](https://render.githubusercontent.com/render/math?math=%5Cdisplaystyle+g%5E%7Bm%2Ar%7D+%2A+g%5Er++%5Cequiv+g%5E%7B%28m%2B1%29%2Ar%7D+%5Cmod+p)が計算できるようになるので、![m](https://render.githubusercontent.com/render/math?math=%5Cdisplaystyle+m)と出力との関係が分かる。

以下のプログラムを実行してフラグが得られた。

```py
lines = open('discrete-log/output.txt').read().splitlines()
p, g = int(lines[0]), int(lines[1])
cs = list(map(int,lines[2][1:-1].split(',')))

# make g^r from known words
# CakeCTF{} = [67, 97, 107, 101, 67, 84, 70, 123, ... , 125]
cs7_inv = pow(cs[7],-1,p)
g2r = (cs[-1]*cs7_inv) % p
cs4_inv = pow(cs[4],-1,p)
g17r = (cs[5]*cs4_inv) % p
g1r = (pow(g2r,9,p) * pow(g17r,-1,p)) % p
g1r_inv = pow(g1r,-1,p)

table = {}
exp = 0
i = 67
while i < 0x7f:
    table[(cs[0]*(g1r**exp))%p] = chr(i)
    exp += 1
    i += 1

exp = 0
i = 67
while i > 0x20:
    table[(cs[0]*(g1r_inv**exp))%p] = chr(i)
    exp += 1
    i -= 1

flag = ''
for c in cs:
    if c in table.keys():
        flag += table[c]
    else:
        flag += '?'

print(flag)
```

<!-- CakeCTF{ba37a0f409ef3ec23a6cffbc474a1cef} -->
